<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta content="summary" name="twitter:card">
        <meta content="http://perlnews.ru/blog/2015/05/14/01-berlin-consensus.html" name="twitter:url">
        <meta content="Берлинский консенсус" name="twitter:title">
        <meta content="На днях был опубликован Берлинский консенсус — финальная договорённость по результатам прошедшего Берлинского QA-хакатона. Данный документ описывает новые соглашения и идеи для репозитория CPAN и …" name="twitter:description">
        <meta content="@perlnews_ru" name="twitter:site">
        <link href="/theme/images/favicon.ico" rel="icon">
        <link href="/theme/css/style.css" rel="stylesheet">
        <title>
            PerlNews.Ru
            → Берлинский консенсус
        </title>
        <script>
  if (window.location.hostname === "perlnews.ru") {
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59283423-1', 'auto');
      ga('send', 'pageview');
  }
</script>

    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">
                        PerlNews.Ru
                        <span class="brand-img"></span>
                    </a>
                    <ul>
                        <li>
                        <a href="/index.html">
                            Новости
                        </a>
                        </li>
                        <li>
                        <a href="/about.html">
                            О блоге
                        </a>
                        </li>
                        <li>
                        <a href="/resources.html">
                            Ресурсы
                        </a>
                        </li>
                        <li>
                        <a href="http://irc.pragmaticperl.com">
                            Чат
                            <span class="typcn typcn-export"></span>
                        </a>
                        </li>
                        <li>
                        <a href="https://twitter.com/perlnews_ru">
                            Twitter
                            <span class="typcn typcn-export"></span>
                        </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
        </header>
        <div class="main container">
            <div class="row">

    <div class="nine columns">
        <main>
            <header>
                <h1>Берлинский консенсус</h1>
                <p class="tags">Темы:
                    <a href="/blog/tag/cpan/" rel="tag">CPAN</a>
                </p>
                <aside>
                    <p><time datetime="2015-05-14">
                        <span class="typcn typcn-time"><span>
                        2015-05-14
                    </span></span></time>
                        <span class="typcn typcn-user"><span>
                        perlnews
                    </span></span></p>
                </aside>
            </header>
            <section id="section-1">
                <p>На днях был опубликован <a href="https://github.com/Perl-Toolchain-Gang/toolchain-site/blob/master/berlin-consensus.md">Берлинский
консенсус</a>
— финальная договорённость по результатам прошедшего <a href="http://perlnews.ru/blog/2015/04/21/02-qa-hackaton-berlin-2015.html">Берлинского
QA-хакатона</a>.
Данный документ описывает новые соглашения и идеи для репозитория CPAN и
тулчейна Perl, а также новые рекомендации для CPAN-авторов. Рассмотрим более
подробно концепции и тезисы Берлинского консенсуса.</p>

            </section>
            <section id="section-2">
                <h2>Поддержание CPAN модулей в целостном и рабочем состоянии</h2>

<p>Приводится аналогия CPAN как реки. Модули, от которых не зависит ни один модуль
на CPAN, находятся около устья реки. Если от модуля начинают зависеть другие
модули, он поднимается вверх по течению реки. Чем больше таких обратных
зависимостей у модуля, тем выше он поднимается вверх по реке. Здесь учитывается
не только явные обратные зависимости, а также обратные зависимости, которые
есть у зависимых модулей. Рассчитав полное число таких зависимостей, можно
выяснить насколько высоко модуль поднимается выше по течению реки.</p>

<p>Если модуль ломается (сборка, тесты, обратная совместимость, и т.д.), то он
ломает и все зависимые модули, т.е. визуально загрязняет реку вниз по течению.
Поэтому, чем больше модуль используется, тем ответственней требуется подходить
к его обновлению и выпуску новых версий.</p>

<p>На сегодняшний день получена примерно следующая статистика зависимостей:</p>

<ul>
<li>~50 дистрибутивов с 10&#39;000 и больше зависимых модулей,</li>
<li>~200 дистрибутивов с 1&#39;000 — 9&#39;999 зависимых модулей,</li>
<li>~2&#39;000 дистрибутивов с 10 — 999 зависимых модулей,</li>
<li>~8&#39;000 дистрибутивов с 1 — 9 зависимых модулей,</li>
<li>~16&#39;000 дистрибутивов без известных зависимых модулей.</li>
</ul>

<p>Выделено три группы и соответствующие рекомендации для авторов модулей,
входящих в заданные группы:</p>

<ul>
<li>Устье реки — ни одного или до 3-4 десятков зависимых модулей. Такие модули
должны удовлетворять следующим правилам:
<ul>
<li>Соответствовать базовым правилам качества
<a href="http://cpants.cpanauthors.org/kwalitee">Kwalitee</a>.</li>
<li>Документация (в идеале с проверкой на грамматические ошибки).</li>
<li>Тесты в папке <code>t</code>.</li>
<li>Лицензия.</li>
<li>Файл Changes с описанием изменений.</li>
<li>Файлы <code>META.json</code> и <code>META.yml</code> в соответствии со спецификацией
<a href="https://metacpan.org/pod/CPAN::Meta::Spec">CPAN::Meta::Spec</a>.</li>
<li>Секция документации <code>SEE ALSO</code>, если модуль реализует функционал, сходный
с существующими модулями, с описанием аналогов и отличий данного модуля
от них.</li>
<li>При сборке не делать лишних подключений в интернет («позвонить домой»);
не делать изменений в файловой системе за пределами каталога дистрибутива
или каталога для временных файлов; не отправлять почту.</li>
<li>Не переопределять другие модули, перезаписывая <code>.pm</code> файлы существующих
модулей  или другим образом нейтрализуя модули из других дистрибутивов.</li>
<li>Не запускать «авторских тестов» на системах пользователя.</li>
<li>Не быть злонамеренным.</li>
<li>Не быть сделанными кое-как.</li>
</ul></li>
<li>Середина реки — от 50 до 2-3 тысяч зависимых модулей. Такие модули должны
удовлетворять всем правилам предыдущего уровня и дополнительно должны:
<ul>
<li>Поддержка стабильного API. Как можно реже делать изменения, ломающие
обратную совместимость. Проводить процедуру постепенного устаревания
функций.</li>
<li>Поддержка переносимости, по возможности, на всех <strong>основных</strong>
архитектурах и операционных системах. Должны быть предприняты шаги по
поддержке старых версий Perl 5.8 и 5.10 и должны иметь явно указанную
минимальную версию Perl в метаданных.</li>
<li>Дистрибутив должен иметь публичный репозиторий.</li>
<li>Дистрибутив должен быть лицензирован с теми же условиями как и сам Perl,
либо иметь <a href="http://opensource.org/licenses/">OSI-совместимую</a> лицензию.
Следует заметить, что GPL-only лицензии могут ограничивать насколько
высоко дистрибутив может подняться вверх по течению реки. Кроме того,
следует учитывать, что не во всех законодательствах действует принцип
отказа от всех прав и передачи в общественное достояние, проще выбрать
лицензию с максимальными передаваемыми правами, такую как CC0.</li>
<li>Автор должен реагировать на сообщения в баг-трекере.</li>
<li>Дистрибутив должен иметь второго майнтейнера, зарегистрированного в PAUSE
или какой-то другой запасной план по передаче управления в случае, если
основной автор не может продолжать работу над модулем.</li>
<li>Дистрибутив должен иметь качественную систему тестов с хорошим покрытием.</li>
<li>Перед релизом стабильных версий должны выпускаться релизы для
разработчиков, не индексируемые на CPAN.</li>
<li>Проверяться результаты сборок в <a href="http://matrix.cpantesters.org/">матрице</a>
CPAN testers.</li>
<li>С осторожностью добавлять или изменять зависимости.</li>
</ul></li>
<li>Исток реки — свыше 3-4 тысяч зависимых модулей. Такие модули должны
удовлетворять всем правилам предыдущих уровней и дополнительно должны:
<ul>
<li>Проводить ревью кода перед стабильными релизами.</li>
<li>Иметь публичный форум для обсуждения. Все заметные изменения должны
обсуждаться перед реализацией.</li>
<li>По возможности должны проектироваться совместимыми со старшими версиями.</li>
<li>C и XS модули должны быть совместимы со стандартом C89, как и сам Perl.</li>
<li>Выполнять тестирование производительности перед релизом больших
изменений.</li>
<li>Тестироваться с bleadperl.</li>
<li>Тестировать некоторые зависимые модули с новой версией, перед релизом.</li>
<li>Релиз стабильных версий должен проводиться в такое время суток и дня
недели, чтобы автор мог быстро отреагировать (откат или фикс) на
возможные последствия.</li>
</ul></li>
</ul>

<h2>Ответственность за форк</h2>

<p>Иногда возникает необходимость в создании форка модуля или альтернативной
реализации. Перед выполнением подобных действий, желательно провести публичное
обсуждение с автором модуля, возможно проблему удастся разрешить без форка.
Если выполнение форка не избежать, то следует публично уведомить автора, в
документации модуля привести рациональные объяснения (стараясь избегать
эмоциональных замечаний или персональной неприязни). Авторам рекомендуется не
«сжигать мосты» и пытаться найти компромиссное решение. После выполнения форка
важно оценить, насколько могут быть затронуты модули вниз по реке, если они
изменят зависимости. Возможно форк привнесёт новые проблемы, которых не было в
оригинальном модуле.</p>

<h2>Инструменты сборки</h2>

<p>К тулчейну, или инструментам сборки, относятся модули, которые требуются для
загрузки, сборки, тестирования и установки большой группы модулей на CPAN. По
определению, модули входящие в состав базового Perl, а также параллельно
развиваемые на CPAN (например, <code>ExtUtils::MakeMaker</code>) относятся к категории
истока реки. Модули, которые не входят в состав Perl, но часто используются в
сборке относятся к категории «тулчейна» для модулей, которые их используют.</p>

<p>Консенсус определяет несколько практик для тулчейна:</p>

<ul>
<li>Инструменты сборки должны поддерживать высокий уровень обратной
совместимости, поддерживая Perl, начиная с 5.8.1.</li>
<li>Должно быть более одного «главного» майнтейнера (независимо от прав на
PAUSE).</li>
<li>Функциональные изменения требуют согласования по крайне мере одного другого
майнтейнера.</li>
<li>Значительные изменения, или изменения, приводящие к поломке обратной
совместимости должны обсуждаться публично, например, в списке рассылки
<a href="http://lists.perl.org/list/cpan-workers.html">cpan-workers</a>.</li>
<li>Если дискуссия над развитием тулчейна не может достигнуть компромисса, автор
должен быть согласен на тай-брейк, когда авторитетный специалист скажет
последнее слово в споре. По умолчанию таким человеком является текущий
майнтейнер Perl (pumpkin).</li>
<li>Стабильная версия не может быть выпущена, пока её стабильность не проверена
(smoke-тестирование). Исключение только в случае экстренных исправлений,
которые должны выполняться без промедления.</li>
<li>Авторы тулчейна должны быть согласны, что если основной майнтейнер отходит от
дел, авторами выбирается новый основной майнтейнер. Администраторы PAUSE
выделяют необходимые права по результатам обсуждения.</li>
</ul>

<h2>Спецификация META</h2>

<p>Обсуждались изменения в спецификации <a href="https://metacpan.org/pod/CPAN::Meta::Spec">CPAN::Meta::Spec</a>.</p>

<ul>
<li>Необходимости в выпуске 3-й версии спецификации нет.</li>
<li>Секция <code>prereqs</code> может содержать поля, которые не могут быть разрешены как
зависимости. Например, <code>perl</code>, <code>Config</code>, <code>Errno</code>. Особенно важно, что ни один
CPAN-клиент не пытался установить perl как зависимость.</li>
<li>Уточнение спецификации: <code>recommends</code> — это зависимости, которые опциональны,
но устанавливаются по умолчанию, а <code>suggests</code> — это зависимости, которые
также опциональны, но не устанавливаются по умолчанию.</li>
<li>Ключ <code>x_breaks</code> теперь должен обрабатываться всеми CPAN-клиентами, который
указывает какие версии каких модулей окажутся сломанными из-за установки
данного модуля. CPAN-клиент должен предпринять принудительно обновление
указанных модулей до установки модуля, если они установлены в системе.</li>
<li>Иногда два модуля могут указывать друг друга в <code>recommends</code>, что приводит к
циклической зависимости. Планируется добавить новый ключ в META, который бы
инструктировал устанавливать зависимость после установки самого модуля.</li>
</ul>

<h2>Только Perl</h2>

<p>Планируется выделить специальную переменную окружения и реализовать её
использование в <code>ExtUtils::CBuilder</code>, которая бы указывала для модулей,
проверяющие наличие компилятора в системе, что компилятора нет. Это позволит
собирать модули, поддерживающие несколько вариантов сборки, только в варианте с
чистым Perl.</p>

<h2>CPAN тестирование</h2>

<p>По историческим причинам отчёты CPAN Testers, в случае если не удалось
установить нужные зависимости не формируются и не рассылаются. Предложено, что
подобные отчёты будут формироваться, но их статус будет отличен от <code>FAIL</code>.</p>

<h2>PAUSE</h2>

<p>Исторически сложилось, что любой желающий мог получить управление заброшенным
модулем, отправив сообщение администраторам PAUSE с просьбой получения прав.
Теперь, в свете концепции реки CPAN, модули с большим числом зависимых модулей
уже довольно опасно отдавать первому встречному. Поэтому принято решение, что
теперь для таких модулей не будет процедуры передачи прав. Дистрибутив, который
лишился майнтейнера, погибает. Всем кто не хочет, чтобы дистрибутив оказался
похоронен на CPAN рекомендуется обзавестись помощником, который бы мог
продолжить сопровождение модуля.</p>

<p>По результатам хакатона было принято решение, что PAUSE не требуется
переписывать с нуля, достаточно того, что PAUSE теперь может запущен под Plack,
что облегчит его тестирование и дальнейшее развитие.</p>

<p>PAUSE начнёт рассылать предупреждения авторам, которые отправляют модули без
указания лицензии.</p>

<p>Также PAUSE должен начать обязательную индексацию META-файлов (META.json или
META.yml) в дистрибутивах.</p>

<p>Будет ускорено удаление старых тарболлов со CPAN (сейчас они хранятся 3 дня).</p>

<h2>Планы развития Test-Simple</h2>

<p>Текущие проблемы <code>Test::Builder</code>:</p>

<ul>
<li>Проблемы с поддержкой асинхронных/параллельных процессов тестирования.</li>
<li>Отсутствия точки расширения, привело к тому, что многие тестовые модули лезут
во внутренности <code>Test::Builder</code> замещая его методы. Такие хаки приводят к
большой хрупкости этих модулей и их зависимостей.</li>
<li>Тестирование модулей тестирование основано на их TAP-выводе, что значительно
усложняет весь процесс. Поэтому сами модули страдают от плохого тестирования.</li>
<li>Привязка к формату TAP ограничивает расширение возможностей тестовой
библиотеки.</li>
<li>Текущий <code>Test::Builder</code> тяжёлый и медленный, содержащий множество
повторяющихся фрагментов кода.</li>
</ul>

<p>С учётом готовящейся замены в виде модуля <code>Test::Stream</code> и, принимая во
внимание риски, были приняты решения:</p>

<ul>
<li>Выпустить релиз для разработчиков Test-Simple.</li>
<li>Подготовить документ со списком всех известных проблем.</li>
<li>Пригласить людей тестировать последние сборки для разработчиков и давать свои
отзывы.</li>
<li>Обновить CPAN-дельта смокеры для тестирования модулей как на стабильной, так
и на разрабатываемой версии Test-Simple.</li>
<li>Ревью кода <code>$Test::Builder::Level</code> в плане обратной совместимости.</li>
<li>Бенчмарки производительности.</li>
</ul>

            </section>
        </main>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'perlnewsru';
            if (window.location.hostname === "perlnews.ru") {
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    <div class="three columns sidebar">
        
        <nav id="tags">
            <h1>Темы</h1>
            <ul class="list-inline">
                <li><a href="/blog/tag/aprilfd/">AprilFD</a></li>
                <li><a href="/blog/tag/benchmark/">benchmark</a></li>
                <li><a href="/blog/tag/books/">books</a></li>
                <li><a href="/blog/tag/bug/">bug</a></li>
                <li><a href="/blog/tag/community/">community</a></li>
                <li><a href="/blog/tag/coro/">Coro</a></li>
                <li><a href="/blog/tag/cpan/">CPAN</a></li>
                <li><a href="/blog/tag/cpanpr/">cpanpr</a></li>
                <li><a href="/blog/tag/cpantesters/">cpantesters</a></li>
                <li><a href="/blog/tag/dbic/">DBIC</a></li>
                <li><a href="/blog/tag/donation/">donation</a></li>
                <li><a href="/blog/tag/facepalm/">facepalm</a></li>
                <li><a href="/blog/tag/fork/">fork</a></li>
                <li><a href="/blog/tag/fosdem/">FOSDEM</a></li>
                <li><a href="/blog/tag/funding/">funding</a></li>
                <li><a href="/blog/tag/hackaton/">hackaton</a></li>
                <li><a href="/blog/tag/ide/">IDE</a></li>
                <li><a href="/blog/tag/interview/">interview</a></li>
                <li><a href="/blog/tag/mojo/">mojo</a></li>
                <li><a href="/blog/tag/moscow-pm/">moscow.pm</a></li>
                <li><a href="/blog/tag/perl/">Perl</a></li>
                <li><a href="/blog/tag/perl6/">Perl6</a></li>
                <li><a href="/blog/tag/perlnews-ru/">PerlNews.Ru</a></li>
                <li><a href="/blog/tag/pragmaticperl/">PragmaticPerl</a></li>
                <li><a href="/blog/tag/regexp/">regexp</a></li>
                <li><a href="/blog/tag/security/">security</a></li>
                <li><a href="/blog/tag/smartmatch/">smartmatch</a></li>
                <li><a href="/blog/tag/starwars/">StarWars</a></li>
                <li><a href="/blog/tag/tips/">tips</a></li>
                <li><a href="/blog/tag/unicode/">unicode</a></li>
                <li><a href="/blog/tag/warnings/">warnings</a></li>
                <li><a href="/blog/tag/windows/">windows</a></li>
                <li><a href="/blog/tag/yapc/">yapc</a></li>
                <li><a href="/blog/tag/briussel/">брюссель</a></li>
                <li><a href="/blog/tag/konferentsiia/">конференция</a></li>
                <li><a href="/blog/tag/pivo/">пиво</a></li>
            </ul>
        </nav>
    </div>

</div>

        </div>
        <footer>
            <div class="container">
<strong>© perlnews.ru</strong>
<p>
Все материалы доступны в соответствии с лицензией
<a href="http://creativecommons.org/licenses/by/4.0/deed.ru">CC BY 4.0</a>
<br>
Работает на
<a href="http://preaction.me/statocles">Statocles</a>
и
<a href="http://www.perl.org">Perl</a>
</p>
</div>

        </footer>
    </body>
</html>
